# TUI设计总览

> **本文档是TUI（Terminal User Interface）设计的总览文档**

---

## 📋 文档信息

- **版本**: v1.0
- **创建日期**: 2025-10-18
- **最后更新**: 2025-10-18
- **负责人**: Claude Code + situruimin

---

## 1. TUI概述

### 1.1 什么是TUI？

**TUI (Terminal User Interface)** 是运行在终端/命令行中的用户界面，使用ASCII字符绘制界面元素（如框、表格、按钮），通过键盘进行交互。

**与其他界面类型的对比**:

| 特性 | CLI | TUI | GUI |
|------|-----|-----|-----|
| **界面形式** | 命令行文本 | ASCII图形界面 | 图形窗口 |
| **交互方式** | 输入命令 | 键盘导航 | 鼠标+键盘 |
| **运行环境** | 终端 | 终端 | 操作系统窗口 |
| **示例工具** | git, npm | htop, vim | VS Code, Chrome |
| **资源占用** | 极低 | 低 | 中高 |
| **开发复杂度** | 低 | 中 | 高 |

**我们的选择**：TUI
- ✅ 比CLI更友好的交互体验
- ✅ 比GUI更轻量、启动更快
- ✅ 无需浏览器，纯终端内操作
- ✅ 跨平台支持（Windows/macOS/Linux）

---

### 1.2 技术选型

#### 候选方案对比

| 框架 | 优势 | 劣势 | 选择 |
|------|------|------|------|
| **blessed** | 成熟稳定、API丰富、社区活跃 | 文档略显陈旧 | ✅ **采用** |
| **ink** | React风格、现代化、TypeScript友好 | 生态较小、复杂场景支持弱 | ❌ |
| **terminal-kit** | 功能强大、动画丰富 | API复杂、学习曲线陡 | ❌ |
| **Charm** (Go) | 性能极佳、跨语言 | 需要Go环境、集成复杂 | ❌ |

**最终选择**：blessed

**原因**：
1. ✅ 成熟稳定：npm下载量超过300万/周
2. ✅ API丰富：box、list、form、table、log等组件齐全
3. ✅ TypeScript支持：有@types/blessed类型定义
4. ✅ 社区活跃：GitHub 11k+ stars
5. ✅ 案例丰富：htop、vtop等知名工具使用

#### 辅助库选择

| 库 | 用途 | 版本 | 选择原因 |
|------|------|------|---------|
| **cli-table3** | 表格渲染 | 0.6.x | 样式丰富、支持复杂表格 |
| **chalk** | 文本颜色 | 5.x | 社区标准、易用 |
| **ora** | 进度动画 | 7.x | 美观的Spinner |
| **boxen** | 边框绘制 | 7.x | 终端弹窗、警告框 |

---

## 2. 界面层级与导航

### 2.1 界面层级结构

```
Level 0: 主界面（MainScreen）
   ├─ 1. AI应用管理 → Level 1-A
   ├─ 2. 开始任务 → Level 1-B
   ├─ 3. 历史记录
   └─ 4. 退出

Level 1-A: AI应用管理（AIManagementScreen）
   ├─ 查看AI列表（状态、登录、到期）
   ├─ 登录/更新操作
   └─ [开始任务→] → Level 1-B

Level 1-B: 任务管理（TaskManagementScreen）
   ├─ 步骤1: 选择AI（多选）
   ├─ 步骤2: 输入问题（多行）
   ├─ 步骤3: 执行模式（串行/方案A/方案B/自动）
   ├─ 步骤4: 输出模式（演示/写库）⭐
   └─ [开始执行] →
        ├─ 演示模式 → Level 2-A → Level 3-A
        └─ 写库模式 → Level 2-B → Level 3-B

Level 2-A: 执行中（演示模式 - ExecutionDemoScreen）
   ├─ 实时进度条（AI×问题矩阵）
   ├─ 实时日志滚动
   └─ 自动跳转 → Level 3-A

Level 2-B: 执行中（写库模式 - ExecutionDBScreen）
   ├─ 实时进度条 + 数据库写入标识（💾）
   ├─ 写入统计
   └─ 自动跳转 → Level 3-B

Level 3-A: 结果展示（演示模式 - ResultDemoScreen）
   ├─ 逐个展示AI回复（← → 切换问题）
   ├─ 并排对比视图
   └─ 手动保存/导出/返回

Level 3-B: 完成总结（写库模式 - ResultDBScreen）
   ├─ 完成统计（成功/失败/耗时）
   ├─ 失败任务列表 + 重试
   └─ 查看详情/新任务/返回
```

### 2.2 导航流程图

```
┌──────────────────────────────────────────────────────────┐
│                     Level 0: 主界面                       │
│                                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │  1. AI应用管理  [未登录提示]                    │   │
│  │  2. 开始任务    [需要至少1个AI已登录]            │   │
│  │  3. 历史记录                                     │   │
│  │  4. 退出                                         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  ↑↓选择 | Enter确认 | Q退出                             │
└────────┬──────────────────┬──────────────────────────────┘
         │                  │
    [选1]│             [选2]│
         ▼                  ▼
┌──────────────────┐  ┌────────────────────────────────────┐
│  Level 1-A:      │  │  Level 1-B: 任务管理                │
│  AI应用管理      │  │                                     │
│                  │  │  步骤1: ☐ 豆包 ☐ Kimi ☐ DeepSeek   │
│  AI列表表格      │  │  步骤2: [输入问题...]               │
│  登录/更新按钮   │  │  步骤3: ⦿ 串行 ○ 方案A ○ 方案B    │
│                  │  │  步骤4: ⦿ 演示模式 ○ 写库模式      │
│  ←返回           │  │                                     │
│  →开始任务       │  │  Tab切换 | Space勾选 | →开始        │
└──────────────────┘  └──────┬──────────────┬───────────────┘
                             │              │
                        [演示]│         [写库]│
                             ▼              ▼
                 ┌───────────────────┐  ┌───────────────────┐
                 │  Level 2-A:       │  │  Level 2-B:       │
                 │  执行中（演示）   │  │  执行中（写库）   │
                 │                   │  │                   │
                 │  进度矩阵         │  │  进度矩阵 + 💾    │
                 │  实时日志         │  │  写入统计         │
                 │                   │  │                   │
                 │  自动跳转 ↓       │  │  自动跳转 ↓       │
                 └───────────────────┘  └───────────────────┘
                             │              │
                             ▼              ▼
                 ┌───────────────────┐  ┌───────────────────┐
                 │  Level 3-A:       │  │  Level 3-B:       │
                 │  结果展示（演示） │  │  完成总结（写库） │
                 │                   │  │                   │
                 │  ← → 切换问题     │  │  成功/失败统计    │
                 │  V 对比视图       │  │  失败任务列表     │
                 │  S 保存           │  │  R 重试           │
                 │  Q 返回           │  │  Q 返回           │
                 └───────────────────┘  └───────────────────┘
```

---

## 3. 双输出模式设计

### 3.1 模式对比

| 特性 | 演示模式（Demo Mode） | 写库模式（Database Mode） |
|------|--------------------|------------------------|
| **触发位置** | Level 1-B步骤4 | Level 1-B步骤4 |
| **执行界面** | Level 2-A | Level 2-B |
| **数据写入** | ❌ 不写库（缓存在内存） | ✅ 立即写库（每完成一个） |
| **进度显示** | 状态图标 | 状态图标 + 💾写库标识 |
| **结果展示** | Level 3-A逐个展示 | Level 3-B完成总结 |
| **失败处理** | 显示错误，不保存 | 记录失败任务，可重试 |
| **手动保存** | ✅ 支持手动保存（S键） | ❌ 已自动保存 |
| **导出功能** | ✅ 导出CSV/JSON | ✅ 导出CSV/JSON |
| **使用场景** | 测试、演示、快速查看 | 生产、积累数据 |

### 3.2 数据流对比

#### 演示模式数据流
```
用户提问 → QueryService.execute(demoMode=true)
                ↓
        Provider1.query() → QueryResult1 →┐
        Provider2.query() → QueryResult2 →├─ 缓存在内存
        Provider3.query() → QueryResult3 →┘
                ↓
         Level 3-A展示结果
                ↓
     [用户按S键] → DatabaseService.save()（可选）
```

#### 写库模式数据流
```
用户提问 → QueryService.execute(demoMode=false)
                ↓
        Provider1.query() → QueryResult1 → DatabaseService.save() → 💾
        Provider2.query() → QueryResult2 → DatabaseService.save() → 💾
        Provider3.query() → QueryResult3 → DatabaseService.save() → 💾
                ↓
         Level 3-B展示统计（成功/失败）
                ↓
      [失败任务] → R键重试 → DatabaseService.update()
```

### 3.3 选择时机

**在Level 1-B任务管理界面的"步骤4"**：

```
┌─────────────────────────────────────────────────────────┐
│ 步骤4: 选择输出模式                                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ⦿ 演示模式（Demo Mode）                                │
│    ├─ 不写入数据库，结果缓存在内存                       │
│    ├─ 适合：测试、演示、快速查看                         │
│    └─ 可手动保存（S键）                                  │
│                                                         │
│  ○ 写库模式（Database Mode）                            │
│    ├─ 立即写入数据库，每完成一个就保存                   │
│    ├─ 适合：生产环境、积累数据                           │
│    └─ 失败任务可重试（R键）                              │
│                                                         │
│  ↑↓选择 | Enter确认                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 键盘交互规范

### 4.1 全局快捷键（所有界面通用）

| 按键 | 功能 | 说明 |
|------|------|------|
| **Q** | 快速返回主界面 | 任何界面都可用 |
| **Ctrl+C** | 取消执行/退出程序 | 强制中断 |
| **↑** | 向上选择/滚动 | 光标上移 |
| **↓** | 向下选择/滚动 | 光标下移 |
| **Enter** | 确认/下一步 | 执行当前选项 |
| **Esc** | 返回上一级 | 取消当前操作 |

### 4.2 上下文快捷键（特定界面）

#### Level 0: 主界面
| 按键 | 功能 |
|------|------|
| **1-4** | 快速选择菜单项 |

#### Level 1-B: 任务管理
| 按键 | 功能 |
|------|------|
| **Tab** | 切换焦点区域（4个步骤间切换） |
| **Space** | 多选勾选/取消（步骤1） |
| **→** | 开始执行 |
| **←** | 返回上一步 |

#### Level 2-A/B: 执行中
| 按键 | 功能 |
|------|------|
| **Ctrl+C** | 中断执行（需要二次确认） |

#### Level 3-A: 结果展示（演示模式）
| 按键 | 功能 |
|------|------|
| **← →** | 切换问题（如果有多个问题） |
| **S** | 保存当前结果到数据库 |
| **C** | 复制全部结果到剪贴板 |
| **V** | 切换并排对比视图 |
| **E** | 导出结果（CSV/JSON） |

#### Level 3-B: 完成总结（写库模式）
| 按键 | 功能 |
|------|------|
| **R** | 重试所有失败任务 |
| **↑ ↓** | 选择单个失败任务 |
| **Enter** | 单独处理选中任务 |
| **D** | 查看详细错误日志 |

### 4.3 交互原则

1. **一致性**：相同功能在不同界面使用相同按键
2. **可发现性**：底栏始终显示当前可用快捷键
3. **可逆性**：任何操作都可撤销或返回
4. **反馈性**：按键后立即显示视觉反馈
5. **容错性**：无效按键不报错，仅忽略

---

## 5. 视觉设计规范

### 5.1 布局结构

所有界面采用统一的三段式布局：

```
┌────────────────────────────────────────────────────────┐
│                      Header（顶栏）                     │  ← 固定高度3行
│  标题 | 当前状态 | 系统信息                             │
├────────────────────────────────────────────────────────┤
│                                                        │
│                    Content（内容区）                    │  ← 可滚动区域
│                                                        │
│                                                        │
│                                                        │
│                                                        │
├────────────────────────────────────────────────────────┤
│                      Footer（底栏）                     │  ← 固定高度2行
│  快捷键提示                                             │
└────────────────────────────────────────────────────────┘
```

### 5.2 颜色规范

使用chalk进行文本着色：

| 语义 | 颜色 | Chalk代码 | 使用场景 |
|------|------|-----------|---------|
| **成功** | 绿色 | `chalk.green()` | ✓ 已登录、✓ 完成、成功消息 |
| **失败** | 红色 | `chalk.red()` | ✗ 未登录、✗ 失败、错误消息 |
| **警告** | 黄色 | `chalk.yellow()` | ⚠️ 即将到期、⚠️ 资源不足 |
| **信息** | 蓝色 | `chalk.blue()` | ℹ️ 提示信息、进度 |
| **高亮** | 青色 | `chalk.cyan()` | 当前选中项、焦点 |
| **弱化** | 灰色 | `chalk.gray()` | 次要信息、禁用项 |
| **强调** | 粗体 | `chalk.bold()` | 标题、重要数字 |

### 5.3 图标规范

使用Unicode字符：

| 含义 | 图标 | Unicode | 使用场景 |
|------|------|---------|---------|
| **成功** | ✓ | U+2713 | 任务完成、登录成功 |
| **失败** | ✗ | U+2717 | 任务失败、未登录 |
| **警告** | ⚠️ | U+26A0 | 警告消息、风险提示 |
| **信息** | ℹ️ | U+2139 | 提示信息、帮助 |
| **进行中** | ⏳ | U+23F3 | 执行中、加载中 |
| **已保存** | 💾 | U+1F4BE | 数据库写入标识 |
| **勾选** | ☑ | U+2611 | 多选已勾选 |
| **未勾选** | ☐ | U+2610 | 多选未勾选 |
| **当前项** | ❯ | U+276F | 当前选中的列表项 |
| **单选已选** | ⦿ | U+29BF | 单选已选中 |
| **单选未选** | ○ | U+25CB | 单选未选中 |

---

## 6. 响应式设计

### 6.1 最小屏幕尺寸

- **最小宽度**：80列（标准终端宽度）
- **最小高度**：24行（标准终端高度）
- **推荐尺寸**：120列 × 40行

### 6.2 自适应策略

| 屏幕宽度 | 布局策略 |
|---------|---------|
| **< 80列** | 显示警告："屏幕过窄，建议调整终端窗口大小" |
| **80-100列** | 紧凑布局：隐藏次要信息、缩短文本 |
| **100-120列** | 标准布局：显示所有信息 |
| **> 120列** | 宽松布局：并排对比视图、更多空白 |

---

## 7. 性能优化

### 7.1 渲染优化

- **按需渲染**：只重绘变化的区域
- **节流更新**：进度条更新频率限制在100ms
- **虚拟滚动**：长列表使用虚拟滚动技术

### 7.2 内存管理

- **日志缓存限制**：最多保留最近1000条日志
- **结果缓存**：演示模式最多缓存100个QueryResult
- **定期清理**：每5分钟清理一次过期缓存

---

## 8. 错误处理

### 8.1 错误类型

1. **登录错误**：验证码过期、网络超时
2. **查询错误**：AI响应超时、网络中断
3. **系统错误**：内存不足、磁盘满

详见：`docs/06-TUI-DESIGN/10-error-handling.md`

---

## 9. 开发规范

### 9.1 组件命名

- **Screen**：完整界面（如`MainScreen.ts`）
- **Component**：可复用组件（如`Header.ts`）
- **Util**：工具函数（如`TUIHelper.ts`）

### 9.2 文件结构

```
src/tui/
├── index.ts                    # TUI入口
├── TUIManager.ts               # TUI核心管理器
├── screens/                    # 界面目录
│   ├── MainScreen.ts           # Level 0
│   ├── AIManagementScreen.ts  # Level 1-A
│   ├── TaskManagementScreen.ts # Level 1-B
│   ├── ExecutionDemoScreen.ts # Level 2-A
│   ├── ExecutionDBScreen.ts   # Level 2-B
│   ├── ResultDemoScreen.ts    # Level 3-A
│   └── ResultDBScreen.ts      # Level 3-B
├── components/                 # 组件目录
│   ├── Header.ts
│   ├── Footer.ts
│   ├── Table.ts
│   ├── ProgressBar.ts
│   ├── StatusIcon.ts
│   └── ErrorDialog.ts
└── utils/                      # 工具目录
    ├── TUIHelper.ts
    ├── KeyboardHandler.ts
    └── LayoutManager.ts
```

---

## 10. 测试策略

### 10.1 测试类型

1. **单元测试**：测试组件渲染和按键响应
2. **集成测试**：测试界面切换和数据流
3. **手动测试**：在真实终端测试交互体验

### 10.2 测试工具

- **Jest**：单元测试框架
- **blessed-contrib**：TUI测试工具
- **terminal-recorder**：录制终端操作

---

## 附录

### A. 相关文档

- `01-level-0-main.md` - Level 0主界面设计
- `02-level-1a-ai-management.md` - Level 1-A AI管理界面
- `03-level-1b-task-management.md` - Level 1-B任务管理界面
- `04-level-2a-execution-demo.md` - Level 2-A执行中界面（演示）
- `05-level-2b-execution-db.md` - Level 2-B执行中界面（写库）
- `06-level-3a-result-demo.md` - Level 3-A结果展示界面（演示）
- `07-level-3b-result-db.md` - Level 3-B完成总结界面（写库）
- `08-components.md` - TUI公共组件设计
- `09-keyboard.md` - 键盘交互详细规范
- `10-error-handling.md` - 错误处理设计

### B. 参考资料

- blessed文档: https://github.com/chjj/blessed
- cli-table3文档: https://github.com/cli-table/cli-table3
- Terminal UI最佳实践: https://github.com/charmbracelet/bubbletea

---

**Last Updated**: 2025-10-18 21:10
**Version**: v1.0
**Status**: 设计完成，待开发
